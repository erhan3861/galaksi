<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LED'li Gece Seyri</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Fredoka', sans-serif;
            background-color: #000;
            user-select: none;
            touch-action: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: center;
        }

        .score-box {
            background: rgba(0, 20, 40, 0.6);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 30px;
            border: 2px solid #00BFFF;
            font-size: 24px;
            color: #00BFFF;
            text-shadow: 0 0 10px #00BFFF;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
        }

        #joystick-zone {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            pointer-events: auto;
            touch-action: none;
        }

        #joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(0, 191, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.6);
            pointer-events: none;
        }

        #start-screen,
        #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 5, 16, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            pointer-events: auto;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .big-btn {
            background: #1E90FF;
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 2rem;
            border-radius: 60px;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
            margin-top: 30px;
            box-shadow: 0 0 30px rgba(30, 144, 255, 0.6);
            transition: transform 0.1s;
            font-weight: bold;
        }

        .big-btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        #controls-hint {
            position: absolute;
            bottom: 220px;
            width: 100%;
            text-align: center;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "canvas-confetti": "https://cdn.skypack.dev/canvas-confetti"
            }
        }
    </script>
</head>

<body>

    <div id="game-container"></div>

    <div id="ui-layer">
        <div class="header">
            <div class="score-box">ðŸ“¦ Kutular: <span id="score">0</span> / 5</div>
        </div>
        <div id="controls-hint">DÃ¼meni kullan! âš“</div>
        <div id="joystick-zone">
            <div id="joystick-knob"></div>
        </div>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 4rem; margin: 0; color: #1E90FF; text-shadow: 0 0 20px #1E90FF;">GECE SEYRÄ°</h1>
        <p style="font-size: 1.5rem; color: #ccc;">KaranlÄ±kta kayÄ±p kutularÄ± bul!</p>
        <button class="big-btn" id="start-btn">BAÅžLA â–¶</button>
    </div>

    <div id="win-screen" class="hidden">
        <h1 style="font-size: 4rem; color: #32CD32;">GÃ–REV TAMAM! âš“</h1>
        <p style="font-size: 2rem;">TÃ¼m kutularÄ± topladÄ±n.</p>
        <button class="big-btn" id="restart-btn">TEKRAR OYNA â†º</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import confetti from 'canvas-confetti';

        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer;
        let ship, spotlight, spotLightTarget;
        let crates = [];
        let rocks = [];
        let score = 0;
        let isGameActive = false;
        let oceanMesh;

        // Movement
        const joystick = { x: 0, y: 0 };
        let shipSpeed = 0;
        let shipAngle = 0;
        const maxSpeed = 0.3;

        init();
        animate();

        function init() {
            // 1. SCENE
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000510);
            scene.fog = new THREE.FogExp2(0x000510, 0.015);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 20);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // LIGHTS
            const ambientLight = new THREE.AmbientLight(0x111122, 0.6);
            scene.add(ambientLight);

            const moonLight = new THREE.DirectionalLight(0xaaccff, 0.3);
            moonLight.position.set(50, 100, 50);
            moonLight.castShadow = true;
            scene.add(moonLight);

            // 2. OBJECTS
            createOcean();
            createShip();
            createLevel();

            // 3. EVENTS
            window.addEventListener('resize', onWindowResize);
            setupJoystick();

            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
        }

        function createOcean() {
            const geo = new THREE.PlaneGeometry(300, 300, 100, 100);
            // Simple vertex displacement shader or just manipulate vertices in animate
            // For simplicity/performance in this context, we'll manipulate vertices
            const mat = new THREE.MeshStandardMaterial({
                color: 0x001e30,
                roughness: 0.2,
                metalness: 0.6,
                flatShading: true
            });
            oceanMesh = new THREE.Mesh(geo, mat);
            oceanMesh.rotation.x = -Math.PI / 2;
            oceanMesh.receiveShadow = true;
            scene.add(oceanMesh);
        }

        function createShip() {
            ship = new THREE.Group();
            scene.add(ship);

            const woodMat = new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.8 });
            const whiteMat = new THREE.MeshStandardMaterial({ color: 0xEEEEEE, roughness: 0.5 });
            const darkMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

            // Hull
            const hullGeo = new THREE.BoxGeometry(2, 1, 5);
            // Taper front
            const positionAttribute = hullGeo.attributes.position;
            for (let i = 0; i < positionAttribute.count; i++) {
                const z = positionAttribute.getZ(i);
                if (z < -2) {
                    positionAttribute.setX(i, positionAttribute.getX(i) * 0.1);
                }
            }
            hullGeo.computeVertexNormals();

            const hull = new THREE.Mesh(hullGeo, woodMat);
            hull.position.y = 0.5;
            hull.castShadow = true;
            ship.add(hull);

            // Cabin
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.2, 2), whiteMat);
            cabin.position.set(0, 1.5, 1);
            cabin.castShadow = true;
            ship.add(cabin);

            // Windows
            const winGeo = new THREE.BoxGeometry(1.6, 0.5, 0.5);
            const win = new THREE.Mesh(winGeo, darkMat);
            win.position.set(0, 1.6, 0.8);
            ship.add(win);

            // Mast
            const mast = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, 4), woodMat);
            mast.position.set(0, 2.5, -0.5);
            ship.add(mast);

            // LED Spotlight
            spotlight = new THREE.SpotLight(0xFFFFFF, 150);
            spotlight.position.set(0, 3, -0.5);
            spotlight.angle = Math.PI / 5;
            spotlight.penumbra = 0.3;
            spotlight.decay = 1.5;
            spotlight.distance = 40;
            spotlight.castShadow = true;

            spotLightTarget = new THREE.Object3D();
            spotLightTarget.position.set(0, 0, -10);
            ship.add(spotLightTarget);
            spotlight.target = spotLightTarget;
            ship.add(spotlight);

            // Bulb Glow
            const bulb = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0xFFFFFF }));
            bulb.position.copy(spotlight.position);
            ship.add(bulb);
        }

        function createLevel() {
            // Crates
            const crateGeo = new THREE.BoxGeometry(1, 1, 1);
            const crateMat = new THREE.MeshStandardMaterial({ color: 0xFFA500, roughness: 0.8 });

            for (let i = 0; i < 5; i++) {
                const crate = new THREE.Mesh(crateGeo, crateMat);
                placeRandomly(crate, 15, 60);
                crate.userData = { type: 'crate', collected: false };
                crate.castShadow = true;
                scene.add(crate);
                crates.push(crate);
            }

            // Rocks
            const rockGeo = new THREE.DodecahedronGeometry(2, 0);
            const rockMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 1 });

            for (let i = 0; i < 20; i++) {
                const rock = new THREE.Mesh(rockGeo, rockMat);
                placeRandomly(rock, 15, 80);
                rock.scale.set(1 + Math.random(), 0.6 + Math.random(), 1 + Math.random());
                rock.castShadow = true;
                rock.receiveShadow = true;
                scene.add(rock);
                rocks.push(rock);
            }
        }

        function placeRandomly(obj, minRadius, maxRadius) {
            const angle = Math.random() * Math.PI * 2;
            const radius = minRadius + Math.random() * (maxRadius - minRadius);
            obj.position.x = Math.sin(angle) * radius;
            obj.position.z = Math.cos(angle) * radius;
            obj.position.y = 0.5;
        }

        function setupJoystick() {
            const zone = document.getElementById('joystick-zone');
            const knob = document.getElementById('joystick-knob');
            let dragging = false;
            let startX, startY;

            const handleStart = (x, y) => {
                dragging = true;
                startX = x;
                startY = y;
                knob.style.transition = 'none';
            };

            const handleMove = (x, y) => {
                if (!dragging) return;
                const dx = x - startX;
                const dy = y - startY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const maxDist = 50;

                const angle = Math.atan2(dy, dx);
                const clampedDist = Math.min(dist, maxDist);

                const moveX = Math.cos(angle) * clampedDist;
                const moveY = Math.sin(angle) * clampedDist;

                knob.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

                // Normalize -1 to 1
                joystick.x = moveX / maxDist;
                joystick.y = moveY / maxDist;
            };

            const handleEnd = () => {
                dragging = false;
                joystick.x = 0;
                joystick.y = 0;
                knob.style.transition = 'transform 0.2s';
                knob.style.transform = 'translate(-50%, -50%)';
            };

            zone.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
            window.addEventListener('mouseup', handleEnd);

            zone.addEventListener('touchstart', e => {
                e.preventDefault();
                handleStart(e.touches[0].clientX, e.touches[0].clientY);
            });
            window.addEventListener('touchmove', e => {
                if (dragging) handleMove(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });
            window.addEventListener('touchend', handleEnd);
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            isGameActive = true;
            score = 0;
            document.getElementById('score').innerText = score;

            ship.position.set(0, 0, 0);
            ship.rotation.y = 0;
            shipAngle = 0;
            shipSpeed = 0;

            crates.forEach(c => {
                c.visible = true;
                c.userData.collected = false;
                placeRandomly(c, 15, 60);
            });
        }

        function restartGame() {
            document.getElementById('win-screen').classList.add('hidden');
            startGame();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            // Ocean Waves
            const positions = oceanMesh.geometry.attributes.position;
            for (let i = 0; i < positions.count; i++) {
                const x = positions.getX(i);
                const y = positions.getY(i); // Actually Z in world space before rotation
                // Simple wave function
                const z = Math.sin(x * 0.2 + time) * 0.5 + Math.cos(y * 0.15 + time * 1.2) * 0.5;
                positions.setZ(i, z);
            }
            positions.needsUpdate = true;

            if (isGameActive) {
                // Joystick Control
                // Y is forward/back speed, X is turn

                // Target speed based on joystick Y (inverted because up is negative Y in screen coords)
                const targetSpeed = -joystick.y * maxSpeed;
                shipSpeed += (targetSpeed - shipSpeed) * 0.05;

                // Turn based on joystick X, only if moving
                if (Math.abs(shipSpeed) > 0.01) {
                    shipAngle -= joystick.x * 0.05;
                }

                ship.rotation.y = shipAngle;
                ship.position.x -= Math.sin(shipAngle) * shipSpeed;
                ship.position.z -= Math.cos(shipAngle) * shipSpeed;

                // Bobbing
                ship.position.y = Math.sin(time * 2) * 0.2;
                ship.rotation.z = Math.sin(time * 1.5) * 0.05 - (joystick.x * 0.2); // Roll into turn
                ship.rotation.x = Math.sin(time * 2) * 0.05 + (shipSpeed * 0.5); // Pitch up when fast

                // Camera Follow
                const targetCamX = ship.position.x + Math.sin(shipAngle) * 15;
                const targetCamZ = ship.position.z + Math.cos(shipAngle) * 15;

                camera.position.x += (targetCamX - camera.position.x) * 0.05;
                camera.position.z += (targetCamZ - camera.position.z) * 0.05;
                camera.lookAt(ship.position);

                // Collisions
                const shipBox = new THREE.Box3().setFromObject(ship);

                crates.forEach(crate => {
                    if (!crate.userData.collected && crate.visible) {
                        crate.position.y = 0.5 + Math.sin(time * 2 + crate.id) * 0.2;
                        crate.rotation.y += 0.01;

                        // Simple distance check is cheaper/smoother than Box3 for spheres/cubes
                        if (ship.position.distanceTo(crate.position) < 3) {
                            crate.userData.collected = true;
                            crate.visible = false;
                            score++;
                            document.getElementById('score').innerText = score;

                            if (score >= 5) {
                                isGameActive = false;
                                document.getElementById('win-screen').classList.remove('hidden');
                                confetti();
                            }
                        }
                    }
                });

                rocks.forEach(rock => {
                    if (ship.position.distanceTo(rock.position) < 3) {
                        // Bounce
                        shipSpeed = -shipSpeed * 0.5;
                        ship.position.x += Math.sin(shipAngle) * 1.0;
                        ship.position.z += Math.cos(shipAngle) * 1.0;
                    }
                });
            }

            renderer.render(scene, camera);
        }
    </script>
</body>

</html>